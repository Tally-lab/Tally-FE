import { useState, useEffect } from "react";
import { useParams, useNavigate } from "react-router-dom";
import {
  ArrowLeft,
  Download,
  GitCommit,
  GitBranch,
  Percent,
} from "lucide-react";
import Header from "../../components/layout/Header";
import StatsCard from "../../components/analysis/StatsCard";
import RoleDistributionChart from "../../components/analysis/RoleDistributionChart";
import ContributionList from "../../components/analysis/ContributionList";
import LoadingSpinner from "../../components/common/LoadingSpinner";

interface ContributionStats {
  id: string;
  userId: string;
  repositoryFullName: string;
  totalCommits: number;
  userCommits: number;
  commitPercentage: number;
  additions?: number;
  deletions?: number;
  roleDistribution?: Record<string, RoleStats>;
  analyzedAt: string;
}

interface RoleStats {
  roleName: string;
  commitCount: number;
  percentage: number;
}

interface PullRequest {
  number: number;
  title: string;
  state: string;
  htmlUrl: string;
  createdAt: string;
  closedAt?: string;
  mergedAt?: string;
}

interface Issue {
  number: number;
  title: string;
  state: string;
  htmlUrl: string;
  createdAt: string;
  closedAt?: string;
}

function downloadFile(content: string, filename: string, mimeType: string) {
  const blob = new Blob([content], { type: mimeType });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

function generateMarkdownReport(
  stats: ContributionStats,
  prs: PullRequest[],
  issues: Issue[],
  owner: string,
  repo: string
): string {
  const date = new Date().toLocaleDateString("ko-KR");

  let markdown = `# ${repo} ê¸°ì—¬ë„ ë¦¬í¬íŠ¸\n\n`;
  markdown += `**ìƒì„±ì¼:** ${date}\n`;
  markdown += `**ë ˆí¬ì§€í† ë¦¬:** ${owner}/${repo}\n\n`;

  markdown += `## ğŸ“Š ê¸°ë³¸ í†µê³„\n\n`;
  markdown += `- **ì´ ì»¤ë°‹ ìˆ˜:** ${stats.totalCommits}ê°œ\n`;
  markdown += `- **ë‚´ ì»¤ë°‹ ìˆ˜:** ${stats.userCommits}ê°œ\n`;
  markdown += `- **ê¸°ì—¬ë„:** ${stats.commitPercentage.toFixed(1)}%\n`;
  markdown += `- **ì½”ë“œ ë³€ê²½:** +${stats.additions} / -${stats.deletions} ë¼ì¸\n\n`;

  if (stats.roleDistribution) {
    markdown += `## ğŸ¯ ì—­í•  ë¶„ì„\n\n`;
    Object.values(stats.roleDistribution).forEach((role) => {
      markdown += `- **${role.roleName}:** ${role.percentage.toFixed(1)}% (${
        role.commitCount
      }ê°œ)\n`;
    });
    markdown += `\n`;
  }

  markdown += `## ğŸ”§ êµ¬í˜„í•œ ê¸°ëŠ¥ (Pull Requests)\n\n`;
  if (prs.length > 0) {
    prs.forEach((pr) => {
      const status = pr.mergedAt ? "âœ…" : pr.state === "closed" ? "âŒ" : "ğŸ”„";
      markdown += `- ${status} ${pr.title} (#${pr.number})\n`;
    });
  } else {
    markdown += `- Pull Requestê°€ ì—†ìŠµë‹ˆë‹¤.\n`;
  }
  markdown += `\n`;

  markdown += `## ğŸ› í•´ê²°í•œ ë¬¸ì œ (Issues)\n\n`;
  if (issues.length > 0) {
    issues.forEach((issue) => {
      const status = issue.state === "closed" ? "âœ…" : "ğŸ”„";
      markdown += `- ${status} ${issue.title} (#${issue.number})\n`;
    });
  } else {
    markdown += `- Issueê°€ ì—†ìŠµë‹ˆë‹¤.\n`;
  }
  markdown += `\n`;

  markdown += `---\n*Generated by Tally*\n`;

  return markdown;
}

function generateHTMLReport(
  stats: ContributionStats,
  prs: PullRequest[],
  issues: Issue[],
  owner: string,
  repo: string
): string {
  const date = new Date().toLocaleDateString("ko-KR");

  let html = `<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${repo} ê¸°ì—¬ë„ ë¦¬í¬íŠ¸</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #5b75ff;
      padding-bottom: 10px;
    }
    h2 {
      color: #555;
      margin-top: 30px;
    }
    .stats {
      background: #e8f5e9;
      padding: 20px;
      border-radius: 5px;
      margin: 20px 0;
    }
    .stats p {
      margin: 10px 0;
      font-size: 16px;
    }
    .role-item {
      padding: 10px;
      margin: 5px 0;
      background: #f0f4ff;
      border-left: 4px solid #5b75ff;
      border-radius: 4px;
    }
    .list-item {
      padding: 10px;
      margin: 5px 0;
      background: #f9f9f9;
      border-left: 4px solid #5b75ff;
      border-radius: 4px;
    }
    .footer {
      text-align: center;
      margin-top: 40px;
      color: #999;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“ˆ ${repo} ê¸°ì—¬ë„ ë¦¬í¬íŠ¸</h1>
    <p><strong>ìƒì„±ì¼:</strong> ${date}</p>
    <p><strong>ë ˆí¬ì§€í† ë¦¬:</strong> ${owner}/${repo}</p>
    
    <div class="stats">
      <h2>ğŸ“Š ê¸°ë³¸ í†µê³„</h2>
      <p><strong>ì´ ì»¤ë°‹ ìˆ˜:</strong> ${stats.totalCommits}ê°œ</p>
      <p><strong>ë‚´ ì»¤ë°‹ ìˆ˜:</strong> ${stats.userCommits}ê°œ</p>
      <p><strong>ê¸°ì—¬ë„:</strong> ${stats.commitPercentage.toFixed(1)}%</p>
      <p><strong>ì½”ë“œ ë³€ê²½:</strong> +${stats.additions} / -${
    stats.deletions
  } ë¼ì¸</p>
    </div>
    
    <h2>ğŸ¯ ì—­í•  ë¶„ì„</h2>`;

  if (stats.roleDistribution) {
    Object.values(stats.roleDistribution).forEach((role) => {
      html += `<div class="role-item"><strong>${
        role.roleName
      }:</strong> ${role.percentage.toFixed(1)}% (${role.commitCount}ê°œ)</div>`;
    });
  }

  html += `<h2>ğŸ”§ êµ¬í˜„í•œ ê¸°ëŠ¥ (Pull Requests)</h2>`;
  if (prs.length > 0) {
    prs.forEach((pr) => {
      const status = pr.mergedAt ? "âœ…" : pr.state === "closed" ? "âŒ" : "ğŸ”„";
      html += `<div class="list-item">${status} ${pr.title} <small>(#${pr.number})</small></div>`;
    });
  } else {
    html += `<p>Pull Requestê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
  }

  html += `<h2>ğŸ› í•´ê²°í•œ ë¬¸ì œ (Issues)</h2>`;
  if (issues.length > 0) {
    issues.forEach((issue) => {
      const status = issue.state === "closed" ? "âœ…" : "ğŸ”„";
      html += `<div class="list-item">${status} ${issue.title} <small>(#${issue.number})</small></div>`;
    });
  } else {
    html += `<p>Issueê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
  }

  html += `
    <div class="footer">
      <p>Generated by Tally</p>
    </div>
  </div>
</body>
</html>`;

  return html;
}

export default function Analysis() {
  const { owner, repo } = useParams<{ owner: string; repo: string }>();
  const navigate = useNavigate();

  const [stats, setStats] = useState<ContributionStats | null>(null);
  const [pullRequests, setPullRequests] = useState<PullRequest[]>([]);
  const [issues, setIssues] = useState<Issue[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isDownloading, setIsDownloading] = useState(false);

  useEffect(() => {
    fetchAnalysisData();
  }, [owner, repo]);

  const fetchAnalysisData = async () => {
    try {
      setIsLoading(true);

      await new Promise((resolve) => setTimeout(resolve, 1500));

      const mockStats: ContributionStats = {
        id: "1",
        userId: "user1",
        repositoryFullName: `${owner}/${repo}`,
        totalCommits: 150,
        userCommits: 87,
        commitPercentage: 58.0,
        additions: 3245,
        deletions: 1120,
        roleDistribution: {
          backend: { roleName: "ë°±ì—”ë“œ", commitCount: 65, percentage: 74.7 },
          frontend: {
            roleName: "í”„ë¡ íŠ¸ì—”ë“œ",
            commitCount: 15,
            percentage: 17.2,
          },
          infrastructure: {
            roleName: "ì¸í”„ë¼",
            commitCount: 7,
            percentage: 8.1,
          },
        },
        analyzedAt: new Date().toISOString(),
      };

      const mockPRs: PullRequest[] = [
        {
          number: 12,
          title: "feat: GitHub OAuth ì¸ì¦ êµ¬í˜„",
          state: "closed",
          htmlUrl: `https://github.com/${owner}/${repo}/pull/12`,
          createdAt: "2025-10-01T10:00:00Z",
          mergedAt: "2025-10-01T15:30:00Z",
        },
        {
          number: 15,
          title: "feat: ê¸°ì—¬ë„ ë¶„ì„ ì—”ì§„ ì¶”ê°€",
          state: "closed",
          htmlUrl: `https://github.com/${owner}/${repo}/pull/15`,
          createdAt: "2025-10-03T09:00:00Z",
          mergedAt: "2025-10-03T16:00:00Z",
        },
        {
          number: 18,
          title: "fix: ë¦¬í¬íŠ¸ ìƒì„± ë²„ê·¸ ìˆ˜ì •",
          state: "open",
          htmlUrl: `https://github.com/${owner}/${repo}/pull/18`,
          createdAt: "2025-10-07T14:00:00Z",
        },
      ];

      const mockIssues: Issue[] = [
        {
          number: 8,
          title: "ì„±ëŠ¥ ìµœì í™” í•„ìš”",
          state: "closed",
          htmlUrl: `https://github.com/${owner}/${repo}/issues/8`,
          createdAt: "2025-09-28T11:00:00Z",
          closedAt: "2025-10-02T16:00:00Z",
        },
        {
          number: 11,
          title: "ì—ëŸ¬ ì²˜ë¦¬ ê°œì„ ",
          state: "closed",
          htmlUrl: `https://github.com/${owner}/${repo}/issues/11`,
          createdAt: "2025-10-01T13:00:00Z",
          closedAt: "2025-10-04T10:00:00Z",
        },
        {
          number: 14,
          title: "ë¬¸ì„œ ì—…ë°ì´íŠ¸",
          state: "open",
          htmlUrl: `https://github.com/${owner}/${repo}/issues/14`,
          createdAt: "2025-10-05T09:00:00Z",
        },
      ];

      setStats(mockStats);
      setPullRequests(mockPRs);
      setIssues(mockIssues);
    } catch (error) {
      console.error("Failed to fetch analysis data:", error);
    } finally {
      setIsLoading(false);
    }
  };

  const handleDownloadMarkdown = async () => {
    if (!stats || !owner || !repo) return;

    try {
      setIsDownloading(true);

      const content = generateMarkdownReport(
        stats,
        pullRequests,
        issues,
        owner,
        repo
      );
      downloadFile(content, `${repo}-contribution-report.md`, "text/markdown");
    } catch (error) {
      console.error("Markdown ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:", error);
      alert("ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    } finally {
      setIsDownloading(false);
    }
  };

  const handleDownloadHTML = async () => {
    if (!stats || !owner || !repo) return;

    try {
      setIsDownloading(true);

      const content = generateHTMLReport(
        stats,
        pullRequests,
        issues,
        owner,
        repo
      );
      downloadFile(content, `${repo}-contribution-report.html`, "text/html");
    } catch (error) {
      console.error("HTML ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:", error);
      alert("ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    } finally {
      setIsDownloading(false);
    }
  };

  if (isLoading) {
    return (
      <div className="min-h-screen bg-gray-50">
        <Header />
        <LoadingSpinner />
      </div>
    );
  }

  if (!stats) {
    return (
      <div className="min-h-screen bg-gray-50">
        <Header />
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
          <div className="text-center">
            <h2 className="text-2xl font-bold text-gray-900">
              ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤
            </h2>
            <button
              onClick={() => navigate("/dashboard")}
              className="mt-4 btn-primary"
            >
              ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
            </button>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <Header />

      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div className="mb-8">
          <button
            onClick={() => navigate("/dashboard")}
            className="flex items-center gap-2 text-gray-600 hover:text-gray-900 mb-4 transition-colors"
          >
            <ArrowLeft className="w-4 h-4" />
            <span>ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</span>
          </button>

          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-3xl font-bold text-gray-900">{repo}</h1>
              <p className="text-gray-600 mt-1">
                {owner} / {repo}
              </p>
            </div>

            <div className="flex gap-3">
              <button
                onClick={handleDownloadMarkdown}
                disabled={isDownloading}
                className="btn-secondary flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <Download className="w-4 h-4" />
                {isDownloading ? "ë‹¤ìš´ë¡œë“œ ì¤‘..." : "Markdown"}
              </button>
              <button
                onClick={handleDownloadHTML}
                disabled={isDownloading}
                className="btn-primary flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <Download className="w-4 h-4" />
                {isDownloading ? "ë‹¤ìš´ë¡œë“œ ì¤‘..." : "HTML"}
              </button>
            </div>
          </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <StatsCard
            icon={GitCommit}
            label="ì´ ì»¤ë°‹ ìˆ˜"
            value={stats.totalCommits}
            subValue="ì „ì²´ í”„ë¡œì íŠ¸"
            color="primary"
          />
          <StatsCard
            icon={GitBranch}
            label="ë‚´ ì»¤ë°‹ ìˆ˜"
            value={stats.userCommits}
            subValue={`${stats.commitPercentage.toFixed(1)}% ê¸°ì—¬`}
            color="success"
          />
          <StatsCard
            icon={Percent}
            label="ê¸°ì—¬ë„"
            value={`${stats.commitPercentage.toFixed(1)}%`}
            subValue={`+${stats.additions} / -${stats.deletions} ë¼ì¸`}
            color="secondary"
          />
        </div>

        {stats.roleDistribution && (
          <div className="mb-8">
            <RoleDistributionChart
              data={{
                backend: stats.roleDistribution.backend?.commitCount || 0,
                frontend: stats.roleDistribution.frontend?.commitCount || 0,
                infrastructure:
                  stats.roleDistribution.infrastructure?.commitCount || 0,
                test: stats.roleDistribution.test?.commitCount || 0,
                documentation:
                  stats.roleDistribution.documentation?.commitCount || 0,
                configuration:
                  stats.roleDistribution.configuration?.commitCount || 0,
                other: stats.roleDistribution.other?.commitCount || 0,
              }}
            />
          </div>
        )}

        <ContributionList pullRequests={pullRequests} issues={issues} />
      </div>
    </div>
  );
}
